<%- include('../layout') %>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>资产统计</div>
        <div>
            <button type="button" class="btn btn-primary" onclick="refreshAssetData()">刷新数据</button>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">设备总价值</h5>
                        <h2 class="card-text" id="totalDeviceValue">¥<%= deviceStats.totalValue || 0 %></h2>
                        <p class="card-text">总数: <%= deviceStats.totalCount || 0 %> 台</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">配件总价值</h5>
                        <h2 class="card-text" id="totalAccessoryValue">¥<%= accessoryStats.totalValue || 0 %></h2>
                        <p class="card-text">总数: <%= accessoryStats.totalCount || 0 %> 件</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">资产总价值</h5>
                        <h2 class="card-text" id="totalAssetValue">¥<%= totalStats.totalValue || 0 %></h2>
                        <p class="card-text">月折旧: ¥<%= totalStats.monthlyDepreciation || 0 %></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        资产价值历史趋势
                    </div>
                    <div class="card-body">
                        <canvas id="assetChart" width="400" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        设备资产明细
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>类别</th>
                                        <th>数量</th>
                                        <th>总价值</th>
                                        <th>月折旧</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (deviceDetails.length === 0) { %>
                                    <tr>
                                        <td colspan="4" class="text-center">暂无设备数据</td>
                                    </tr>
                                    <% } else { %>
                                        <% deviceDetails.forEach(detail => { %>
                                        <tr>
                                            <td><%= detail.category %></td>
                                            <td><%= detail.count %></td>
                                            <td>¥<%= detail.totalValue %></td>
                                            <td>¥<%= detail.monthlyDepreciation %></td>
                                        </tr>
                                        <% }) %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        配件资产明细
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>类别</th>
                                        <th>数量</th>
                                        <th>总价值</th>
                                        <th>月折旧</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (accessoryDetails.length === 0) { %>
                                    <tr>
                                        <td colspan="4" class="text-center">暂无配件数据</td>
                                    </tr>
                                    <% } else { %>
                                        <% accessoryDetails.forEach(detail => { %>
                                        <tr>
                                            <td><%= detail.category %></td>
                                            <td><%= detail.count %></td>
                                            <td>¥<%= detail.totalValue %></td>
                                            <td>¥<%= detail.monthlyDepreciation %></td>
                                        </tr>
                                        <% }) %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 准备图表数据
const chartData = {
    labels: <%= JSON.stringify(chartData.labels) %>,
    datasets: [
        {
            label: '设备价值',
            data: <%= JSON.stringify(chartData.deviceValues) %>,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            tension: 0.1
        },
        {
            label: '配件价值',
            data: <%= JSON.stringify(chartData.accessoryValues) %>,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            tension: 0.1
        },
        {
            label: '总价值',
            data: <%= JSON.stringify(chartData.totalValues) %>,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 2,
            tension: 0.1
        }
    ]
};

// 创建图表
const ctx = document.getElementById('assetChart').getContext('2d');
const assetChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '¥' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += '¥' + context.parsed.y.toLocaleString();
                        }
                        return label;
                    }
                }
            }
        }
    }
});

// 刷新数据
function refreshAssetData() {
    // 获取正确的配件总数
    fetch('/api/accessories/total-count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#totalAccessoryValue').nextElementSibling.textContent = `总数: ${data.totalCount} 件`;
            }
        })
        .catch(error => console.error('获取配件总数失败:', error));
    
    // 延迟刷新页面
    setTimeout(() => window.location.reload(), 500);
}

// 页面加载时获取正确的配件总数
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/accessories/total-count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#totalAccessoryValue').nextElementSibling.textContent = `总数: ${data.totalCount} 件`;
            }
        })
        .catch(error => console.error('获取配件总数失败:', error));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>