<%- include('../layout') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div></div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshData">
                <i class="bi bi-arrow-clockwise"></i> 刷新数据
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="generateSnapshot">
                <i class="bi bi-camera"></i> 生成月度快照
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" id="generateHistorySnapshots">
                <i class="bi bi-calendar-history"></i> 生成历史快照
            </button>
        </div>
    </div>
</div>

<!-- 当前资产概览 -->
<div class="row mb-4">
    <!-- 设备总价值 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-xs font-weight-bold text-primary text-uppercase">设备总价值</div>
                    <div class="text-muted"><i class="bi bi-pc-display"></i></div>
                </div>
                <div class="small text-muted">采购时价格</div>
                <div class="h6 mb-2 font-weight-bold text-gray-800" id="equipmentOriginalValue">¥0.00</div>
                <div class="small text-muted">现在的价格</div>
                <div class="h6 mb-0 font-weight-bold text-gray-800" id="equipmentCurrentValue">¥0.00</div>
            </div>
        </div>
    </div>

    <!-- 配件总价值 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-xs font-weight-bold text-success text-uppercase">配件总价值</div>
                    <div class="text-muted"><i class="bi bi-cpu"></i></div>
                </div>
                <div class="small text-muted">采购时价格</div>
                <div class="h6 mb-2 font-weight-bold text-gray-800" id="accessoryOriginalValue">¥0.00</div>
                <div class="small text-muted">现在的价格</div>
                <div class="h6 mb-0 font-weight-bold text-gray-800" id="accessoryCurrentValue">¥0.00</div>
            </div>
        </div>
    </div>

    <!-- 资产总值 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-xs font-weight-bold text-info text-uppercase">资产总值</div>
                    <div class="text-muted"><i class="bi bi-graph-up"></i></div>
                </div>
                <div class="small text-muted">采购时价格</div>
                <div class="h6 mb-2 font-weight-bold text-gray-800" id="assetOriginalValue">¥0.00</div>
                <div class="small text-muted">现在的价格</div>
                <div class="h6 mb-0 font-weight-bold text-gray-800" id="assetCurrentValue">¥0.00</div>
            </div>
        </div>
    </div>

    <!-- 累计折旧 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase">累计折旧</div>
                    <div class="text-muted"><i class="bi bi-graph-down"></i></div>
                </div>
                <div class="small text-muted">资产现在的总价值 - 采购时的总价值</div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDepreciation">¥0.00</div>
            </div>
        </div>
    </div>
</div>

<!-- 资产历史图表 -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">资产历史走向</h6>
                <div class="dropdown no-arrow d-flex align-items-center">
                    <select class="form-select form-select-sm me-2" id="chartPeriod" style="width: auto;">
                        <option value="6">最近6个月</option>
                        <option value="12" selected>最近12个月</option>
                        <option value="24">最近24个月</option>
                        <option value="custom">自定义</option>
                    </select>
                    <input type="number" class="form-control form-control-sm" id="customMonths" 
                           min="1" max="120" placeholder="输入月数" style="width: 120px; display: none;">
                    <button class="btn btn-sm btn-primary ms-2" id="applyCustomMonths" 
                            style="display: none;">应用</button>
                    <div class="ms-3 text-muted small" id="currentMonthDisplay">当前显示: 最近12个月</div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="assetHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 月度快照表格 -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">月度资产快照（配件）</h6>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="viewSnapshotHistory">
            查看历史
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="assetSnapshotsTable">
                <thead>
                    <tr>
                        <th>月份</th>
                        <th>新增配件数量</th>
                        <th>新增配件总价值</th>
                        <th>报废配件数量</th>
                        <th>报废配件总价值</th>
                        <th>配件总数</th>
                        <th>配件总价值</th>
                    </tr>
                </thead>
                <tbody id="assetSnapshotsBody">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 月度资产快照历史 Modal -->
<div class="modal fade" id="snapshotHistoryModal" tabindex="-1" aria-labelledby="snapshotHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="snapshotHistoryModalLabel">资产快照历史（配件）</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>月份</th>
                                <th>新增配件数量</th>
                                <th>新增配件总价值</th>
                                <th>报废配件数量</th>
                                <th>报废配件总价值</th>
                                <th>配件总数</th>
                                <th>配件总价值</th>
                            </tr>
                        </thead>
                        <tbody id="snapshotHistoryBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 全局变量
let assetHistoryChart = null;

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    loadAssetData();
    initCharts();
    loadAssetSnapshots();
    updateMonthDisplay(12); // 初始显示12个月
    
    // 事件监听
    document.getElementById('refreshData').addEventListener('click', function() {
        loadAssetData();
        loadAssetSnapshots();
        updateCharts();
    });
    
    document.getElementById('generateSnapshot').addEventListener('click', generateAssetSnapshot);
    document.getElementById('generateHistorySnapshots').addEventListener('click', generateHistoryAssetSnapshots);
    document.getElementById('chartPeriod').addEventListener('change', handleChartPeriodChange);
    document.getElementById('applyCustomMonths').addEventListener('click', applyCustomMonths);
    document.getElementById('customMonths').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            applyCustomMonths();
        }
    });
    document.getElementById('viewSnapshotHistory').addEventListener('click', function() {
        loadSnapshotHistory();
        const modalElement = document.getElementById('snapshotHistoryModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    });
});

// 加载当前资产数据
function loadAssetData() {
    fetch('/api/assets/current')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 设备总价值
                document.getElementById('equipmentOriginalValue').textContent = '¥' + data.equipmentOriginalValue.toFixed(2);
                document.getElementById('equipmentCurrentValue').textContent = '¥' + data.equipmentCurrentValue.toFixed(2);

                // 配件总价值
                document.getElementById('accessoryOriginalValue').textContent = '¥' + data.accessoryOriginalValue.toFixed(2);
                document.getElementById('accessoryCurrentValue').textContent = '¥' + data.accessoryCurrentValue.toFixed(2);

                // 资产总值
                document.getElementById('assetOriginalValue').textContent = '¥' + data.assetOriginalValue.toFixed(2);
                document.getElementById('assetCurrentValue').textContent = '¥' + data.assetCurrentValue.toFixed(2);

                // 累计折旧 / 资产贬值
                document.getElementById('totalDepreciation').textContent = '¥' + data.totalDepreciation.toFixed(2);
            } else {
                console.error('获取资产数据失败');
            }
        })
        .catch(error => {
            console.error('Error loading asset data:', error);
        });
}

// 初始化图表
function initCharts() {
    // 资产历史图表
    const historyCtx = document.getElementById('assetHistoryChart').getContext('2d');
    assetHistoryChart = new Chart(historyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '配件总价值',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toFixed(0);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ¥' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

// 处理图表期间选择变化
function handleChartPeriodChange() {
    const chartPeriod = document.getElementById('chartPeriod').value;
    const customMonthsInput = document.getElementById('customMonths');
    const applyButton = document.getElementById('applyCustomMonths');
    
    if (chartPeriod === 'custom') {
        customMonthsInput.style.display = 'block';
        applyButton.style.display = 'block';
        customMonthsInput.focus();
    } else {
        customMonthsInput.style.display = 'none';
        applyButton.style.display = 'none';
        updateCharts();
    }
}

// 应用自定义月份数
function applyCustomMonths() {
    const customMonths = parseInt(document.getElementById('customMonths').value);
    
    if (!customMonths || customMonths < 1) {
        alert('请输入有效的月份数（至少1个月）');
        return;
    }
    
    if (customMonths > 120) {
        alert('最多只能查看120个月（10年）的历史数据');
        return;
    }
    
    updateCharts(customMonths);
    updateMonthDisplay(customMonths);
}

// 更新月份显示文本
function updateMonthDisplay(months) {
    const displayElement = document.getElementById('currentMonthDisplay');
    if (months <= 24) {
        const periodSelect = document.getElementById('chartPeriod');
        const selectedOption = periodSelect.options[periodSelect.selectedIndex];
        displayElement.textContent = `当前显示: ${selectedOption.text}`;
    } else {
        displayElement.textContent = `当前显示: 最近${months}个月`;
    }
}

// 更新图表数据
function updateCharts(customMonths) {
    let months;
    
    if (customMonths) {
        months = customMonths;
    } else {
        months = document.getElementById('chartPeriod').value;
        updateMonthDisplay(months);
    }
    
    fetch(`/api/assets/history?months=${months}`)
        .then(response => response.json())
        .then(data => {
            console.log('API返回的数据:', data); // 添加调试日志
            console.log('history数组长度:', data.history ? data.history.length : 0); // 添加调试日志
            if (data.history && data.history.length > 0) {
                console.log('第一条历史记录:', data.history[0]);
                console.log('最后一条历史记录:', data.history[data.history.length-1]);
            }
            
            if (data.success) {
                // 数据是按时间降序的，需要反转以按时间升序显示
                const historyData = data.history.slice().reverse();
                
                // 更新历史图表 - 只显示配件总价值
                assetHistoryChart.data.labels = historyData.map(item => {
                    // 直接使用API返回的record_date，格式已经是YYYY-MM
                    return item.record_date;
                });
                
                assetHistoryChart.data.datasets[0].data = historyData.map(item => item.total_value || 0);
                
                console.log('图表数据 - 标签:', assetHistoryChart.data.labels);
                console.log('图表数据 - 值:', assetHistoryChart.data.datasets[0].data);
                
                assetHistoryChart.update();
                
                // 检查是否是示例数据
                if (data.isSampleData) {
                    // 显示提示信息
                    const chartArea = document.querySelector('.chart-area');
                    // 移除可能存在的旧提示
                    const oldAlert = chartArea.querySelector('.alert-info');
                    if (oldAlert) {
                        oldAlert.remove();
                    }
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-info mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-info-circle"></i> 当前显示的是示例数据。要查看真实的历史数据，请点击"生成历史快照"按钮。';
                    chartArea.appendChild(alertDiv);
                } else {
                    // 移除可能存在的提示
                    const oldAlert = chartArea.querySelector('.alert-info');
                    if (oldAlert) {
                        oldAlert.remove();
                    }
                }
            } else {
                console.error('API返回失败:', data);
            }
        })
        .catch(error => {
            console.error('Error updating charts:', error);
        });
}

// 加载月度快照（仅当月，按配件统计）
function loadAssetSnapshots() {
    fetch('/api/assets/accessory-snapshot/current')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('assetSnapshotsBody');
            tbody.innerHTML = '';

            if (!data.success) {
                console.error('获取配件资产快照失败');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">加载数据失败</td></tr>';
                return;
            }

            // 获取实时配件数量（与配件库存统计一致）
            fetch('/api/assets/accessory-quantity/realtime')
                .then(response => response.json())
                .then(realtimeData => {
                    let totalQty = 0;
                    let totalValue = 0;

                    if (data.snapshot) {
                        // 如果有快照，使用快照中的其他数据，但使用实时配件数量
                        const snapshot = data.snapshot;
                        const date = new Date(snapshot.snapshot_month);
                        const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');

                        const newQty = snapshot.new_accessory_quantity || 0;
                        const newValue = Number(snapshot.new_accessory_total_value || 0).toFixed(2);
                        const scrapQty = snapshot.scrapped_accessory_quantity || 0;
                        const scrapValue = Number(snapshot.scrapped_accessory_total_value || 0).toFixed(2);
                        
                        // 使用实时数量替换快照中的数量
                        totalQty = realtimeData.success ? realtimeData.totalCount : snapshot.total_accessory_quantity || 0;
                        // 使用快照中的总价值（因为计算复杂）
                        totalValue = Number(snapshot.total_accessory_total_value || 0).toFixed(2);

                        tbody.innerHTML = `
                            <tr>
                                <td>${dateStr}</td>
                                <td>${newQty}</td>
                                <td>¥${newValue}</td>
                                <td>${scrapQty}</td>
                                <td>¥${scrapValue}</td>
                                <td class="text-info font-weight-bold">${totalQty} <small class="text-muted">(实时)</small></td>
                                <td>¥${totalValue}</td>
                            </tr>
                        `;
                    } else {
                        // 如果没有快照，只显示实时数量
                        totalQty = realtimeData.success ? realtimeData.totalCount : 0;
                        totalValue = 0;

                        const today = new Date();
                        const dateStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');

                        tbody.innerHTML = `
                            <tr>
                                <td>${dateStr}</td>
                                <td>0</td>
                                <td>¥0.00</td>
                                <td>0</td>
                                <td>¥0.00</td>
                                <td class="text-info font-weight-bold">${totalQty} <small class="text-muted">(实时)</small></td>
                                <td>¥${totalValue.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading real-time accessory quantity:', error);
                    // 如果获取实时数量失败，使用快照数据
                    if (data.snapshot) {
                        const snapshot = data.snapshot;
                        const date = new Date(snapshot.snapshot_month);
                        const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');

                        const newQty = snapshot.new_accessory_quantity || 0;
                        const newValue = Number(snapshot.new_accessory_total_value || 0).toFixed(2);
                        const scrapQty = snapshot.scrapped_accessory_quantity || 0;
                        const scrapValue = Number(snapshot.scrapped_accessory_total_value || 0).toFixed(2);
                        const totalQty = snapshot.total_accessory_quantity || 0;
                        const totalValue = Number(snapshot.total_accessory_total_value || 0).toFixed(2);

                        tbody.innerHTML = `
                            <tr>
                                <td>${dateStr}</td>
                                <td>${newQty}</td>
                                <td>¥${newValue}</td>
                                <td>${scrapQty}</td>
                                <td>¥${scrapValue}</td>
                                <td>${totalQty}</td>
                                <td>¥${totalValue}</td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">本月配件资产快照尚未生成，请点击上方"生成月度快照"按钮</td></tr>';
                    }
                });
        })
        .catch(error => {
            console.error('Error loading accessory asset snapshot:', error);
            const tbody = document.getElementById('assetSnapshotsBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">加载数据失败</td></tr>';
        });
}

// 加载历史配件资产快照
function loadSnapshotHistory() {
    fetch('/api/assets/accessory-snapshot/history')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('snapshotHistoryBody');
            tbody.innerHTML = '';

            if (!data.success) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">加载历史数据失败</td></tr>';
                return;
            }

            if (!data.snapshots || data.snapshots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无历史快照</td></tr>';
                return;
            }

            data.snapshots.forEach(snapshot => {
                const date = new Date(snapshot.snapshot_month);
                const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');

                const newQty = snapshot.new_accessory_quantity || 0;
                const newValue = Number(snapshot.new_accessory_total_value || 0).toFixed(2);
                const scrapQty = snapshot.scrapped_accessory_quantity || 0;
                const scrapValue = Number(snapshot.scrapped_accessory_total_value || 0).toFixed(2);
                const totalQty = snapshot.total_accessory_quantity || 0;
                const totalValue = Number(snapshot.total_accessory_total_value || 0).toFixed(2);

                tbody.innerHTML += `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${newQty}</td>
                        <td>¥${newValue}</td>
                        <td>${scrapQty}</td>
                        <td>¥${scrapValue}</td>
                        <td>${totalQty}</td>
                        <td>¥${totalValue}</td>
                    </tr>
                `;
            });
        })
        .catch(error => {
            console.error('Error loading accessory asset snapshot history:', error);
            const tbody = document.getElementById('snapshotHistoryBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">加载历史数据失败</td></tr>';
        });
}

// 生成资产快照（配件月度快照）
function generateAssetSnapshot() {
    if (!confirm('确定要生成当前月份的配件资产快照吗？')) {
        return;
    }
    
    const button = document.getElementById('generateSnapshot');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';
    
    fetch('/api/assets/accessory-snapshot/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('配件资产快照生成成功！');
            loadAssetSnapshots();
        } else {
            alert('生成失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error generating accessory asset snapshot:', error);
        alert('生成快照时发生错误');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-camera"></i> 生成月度快照';
    });
}

// 生成历史资产快照（从2023年以来每个月）
function generateHistoryAssetSnapshots() {
    if (!confirm('确定要生成从2023年以来每个月的资产快照吗？这个过程可能需要一些时间，请耐心等待。')) {
        return;
    }
    
    const button = document.getElementById('generateHistorySnapshots');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';
    
    fetch('/api/assets/accessory-snapshot/generate-history', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('历史资产快照生成成功！生成了 ' + data.count + ' 个月的快照。');
            updateCharts(); // 重新加载图表
        } else {
            alert('生成失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error generating history asset snapshots:', error);
        alert('生成历史快照时发生错误');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-calendar-history"></i> 生成历史快照';
    });
}
</script>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}
.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}
.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}
.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}
.text-xs {
    font-size: 0.7rem;
}
.chart-area {
    position: relative;
    height: 30rem;
    width: 100%;
}
/* 自定义月份输入样式 */
#customMonths:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}
</style>