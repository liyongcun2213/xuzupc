<%- include('../layout') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">采购详情</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/purchases" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">基本信息</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">批次号:</div>
                    <div class="col-sm-8"><%= batch.batch_no %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">供应商:</div>
                    <div class="col-sm-8"><%= batch.supplier_name || '未知供应商' %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">采购日期:</div>
                    <div class="col-sm-8"><%= moment(batch.purchase_date).format('YYYY-MM-DD') %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">预计到货日期:</div>
                    <div class="col-sm-8"><%= batch.expected_delivery_date ? moment(batch.expected_delivery_date).format('YYYY-MM-DD') : '未设定' %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">状态:</div>
                    <div class="col-sm-8">
                        <% let statusClass = 'secondary'; %>
                        <% let statusText = batch.status; %>
                        <% if (batch.status === 'pending') { %>
                            <% statusClass = 'warning'; statusText = '待审批'; %>
                        <% } else if (batch.status === 'approved') { %>
                            <% statusClass = 'info'; statusText = '已审批'; %>
                        <% } else if (batch.status === 'delivered') { %>
                            <% statusClass = 'primary'; statusText = '已到货'; %>
                        <% } else if (batch.status === 'completed') { %>
                            <% statusClass = 'success'; statusText = '已完成'; %>
                        <% } else if (batch.status === 'cancelled') { %>
                            <% statusClass = 'danger'; statusText = '已取消'; %>
                        <% } %>
                        <span class="badge bg-<%= statusClass %>"><%= statusText %></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">创建人:</div>
                    <div class="col-sm-8"><%= batch.created_by_name || '系统' %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">创建时间:</div>
                    <div class="col-sm-8"><%= moment(batch.created_at).format('YYYY-MM-DD HH:mm:ss') %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">备注:</div>
                    <div class="col-sm-8"><%= batch.notes || '无' %></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">财务信息</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">总金额:</div>
                    <div class="col-sm-8 fw-bold">¥<%= (Number(batch.total_amount) || 0).toFixed(2) %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">已支付:</div>
                    <div class="col-sm-8 fw-bold">¥<%= (Number(batch.paid_amount) || 0).toFixed(2) %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4 text-muted">未支付:</div>
                    <div class="col-sm-8 fw-bold text-danger">¥<%= ((Number(batch.total_amount) || 0) - (Number(batch.paid_amount) || 0)).toFixed(2) %></div>
                </div>
                
                <% if (user.role === 'admin' || user.role === 'finance') { %>
                <hr>
                <div class="d-grid gap-2">
                    <% if (batch.status === 'pending' && (user.role === 'admin' || user.role === 'finance')) { %>
                        <button type="button" class="btn btn-success" onclick="approvePurchase(<%= batch.id %>)">
                            <i class="bi bi-check-circle"></i> 审批通过
                        </button>
                    <% } %>
                    <% if (batch.status === 'approved' && (parseFloat(batch.total_amount) > parseFloat(batch.paid_amount))) { %>
                        <button type="button" class="btn btn-primary" onclick="showPaymentModal()">
                            <i class="bi bi-credit-card"></i> 支付款项
                        </button>
                    <% } %>
                    <% if (batch.status === 'approved') { %>
                        <button type="button" class="btn btn-info" onclick="markDelivered(<%= batch.id %>)">
                            <i class="bi bi-truck"></i> 标记到货
                        </button>
                    <% } %>
                    <% if (batch.status === 'delivered') { %>
                        <button type="button" class="btn btn-secondary" onclick="completePurchase(<%= batch.id %>)">
                            <i class="bi bi-check2-all"></i> 完成采购
                        </button>
                    <% } %>
                    <% if (batch.status !== 'completed' && batch.status !== 'cancelled') { %>
                        <button type="button" class="btn btn-danger" onclick="cancelPurchase(<%= batch.id %>)">
                            <i class="bi bi-x-circle"></i> 取消采购
                        </button>
                    <% } %>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">采购明细</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="itemsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="accessories-tab" data-bs-toggle="tab" data-bs-target="#accessories" type="button" role="tab">配件明细</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">设备明细</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="itemsTabContent">
                    <div class="tab-pane fade show active" id="accessories" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>配件名称</th>
                                        <th>品牌/型号</th>
                                        <th>采购数量</th>
                                        <th>单价</th>
                                        <th>小计</th>
                                        <th>已入库数量</th>
                                        <th>入库状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (typeof accessories !== 'undefined' && accessories.length > 0) { %>
                                        <% accessories.forEach(item => { %>
                                            <tr>
                                                <td><%= item.name %></td>
                                                <td><%= item.brand && item.model ? item.brand + ' ' + item.model : (item.brand || item.model || '-') %></td>
                                                <td class="text-center"><%= item.quantity %></td>
                                                <td class="text-end">¥<%= (Number(item.unit_price) || 0).toFixed(2) %></td>
                                                <td class="text-end">¥<%= (Number(item.total_price) || 0).toFixed(2) %></td>
                                                <td class="text-center"><%= item.delivered_quantity || 0 %></td>
                                                <td class="text-center">
                                                    <% let statusClass = 'secondary'; %>
                                                    <% let statusText = item.status; %>
                                                    <% if (item.status === 'pending') { statusClass = 'warning'; statusText = '待入库'; } else if (item.status === 'partial_delivered') { statusClass = 'info'; statusText = '部分入库'; } else if (item.status === 'delivered') { statusClass = 'success'; statusText = '已入库'; } %>
                                                    <span class="badge bg-<%= statusClass %>"><%= statusText %></span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-3">无配件采购明细</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="devices" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>设备名称</th>
                                        <th>品牌/型号</th>
                                        <th>采购数量</th>
                                        <th>单价</th>
                                        <th>小计</th>
                                        <th>已入库数量</th>
                                        <th>入库状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (typeof devices !== 'undefined' && devices.length > 0) { %>
                                        <% devices.forEach(item => { %>
                                            <tr>
                                                <td><%= item.name %></td>
                                                <td><%= item.brand && item.model ? item.brand + ' ' + item.model : (item.brand || item.model || '-') %></td>
                                                <td class="text-center"><%= item.quantity %></td>
                                                <td class="text-end">¥<%= (Number(item.unit_price) || 0).toFixed(2) %></td>
                                                <td class="text-end">¥<%= (Number(item.total_price) || 0).toFixed(2) %></td>
                                                <td class="text-center"><%= item.delivered_quantity || 0 %></td>
                                                <td class="text-center">
                                                    <% let statusClass = 'secondary'; %>
                                                    <% let statusText = item.status; %>
                                                    <% if (item.status === 'pending') { statusClass = 'warning'; statusText = '待入库'; } else if (item.status === 'partial_delivered') { statusClass = 'info'; statusText = '部分入库'; } else if (item.status === 'delivered') { statusClass = 'success'; statusText = '已入库'; } %>
                                                    <span class="badge bg-<%= statusClass %>"><%= statusText %></span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-3">无设备采购明细</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">审批记录</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>审批类型</th>
                                <th>审批人</th>
                                <th>审批状态</th>
                                <th>审批日期</th>
                                <th>审批金额</th>
                                <th>审批意见</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (typeof approvals !== 'undefined' && approvals.length > 0) { %>
                                <% approvals.forEach(approval => { %>
                                    <tr>
                                        <td>
                                            <% let typeText = approval.approval_type; %>
                                            <% if (approval.approval_type === 'approve') { typeText = '审批通过'; } else if (approval.approval_type === 'payment') { typeText = '支付款项'; } else if (approval.approval_type === 'cancel') { typeText = '取消采购'; } else if (approval.approval_type === 'complete') { typeText = '完成采购'; } %>
                                            <%= typeText %>
                                        </td>
                                        <td><%= approval.approver_name || '系统' %></td>
                                        <td>
                                            <% let statusClass = 'secondary'; %>
                                            <% let statusText = approval.approval_status; %>
                                            <% if (approval.approval_status === 'pending') { statusClass = 'warning'; statusText = '待审批'; } else if (approval.approval_status === 'approved') { statusClass = 'success'; statusText = '已通过'; } else if (approval.approval_status === 'rejected') { statusClass = 'danger'; statusText = '已拒绝'; } %>
                                            <span class="badge bg-<%= statusClass %>"><%= statusText %></span>
                                        </td>
                                        <td><%= approval.approval_date ? moment(approval.approval_date).format('YYYY-MM-DD HH:mm:ss') : '-' %></td>
                                        <td class="text-end">
                                            <% if (approval.amount) { %>¥<%= parseFloat(approval.amount).toFixed(2) %><% } else { %>-<% } %>
                                        </td>
                                        <td><%= approval.notes || '-' %></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="text-center py-3">暂无审批记录</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 支付模态框 -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">支付款项</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="paymentAmount" class="form-label">支付金额</label>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" max="<%= (parseFloat(batch.total_amount) - parseFloat(batch.paid_amount)).toFixed(2) %>" value="<%= (parseFloat(batch.total_amount) - parseFloat(batch.paid_amount)).toFixed(2) %>">
                    </div>
                    <div class="form-text">最大可支付金额: ¥<%= (parseFloat(batch.total_amount) - parseFloat(batch.paid_amount)).toFixed(2) %></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paymentAccountCode" class="form-label">支付账户（公账/私账） <span class="text-danger">*</span></label>
                        <select class="form-select" id="paymentAccountCode">
                            <option value="public" selected>公司公账</option>
                            <option value="private">法人私账</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="paymentNotes" class="form-label">支付说明</label>
                        <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="processPayment()">确认支付</button>
            </div>
        </div>
    </div>
</div>

<script>
// 审批采购
function approvePurchase(batchId) {
    if (confirm('确定要审批通过这个采购批次吗？')) {
        fetch('/purchases/approve/' + batchId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('审批成功！');
                location.reload();
            } else {
                alert('审批失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败，请稍后重试');
        });
    }
}

// 标记到货
function markDelivered(batchId) {
    if (confirm('确定要将此采购批次标记为已到货吗？')) {
        fetch('/purchases/delivered/' + batchId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('标记成功！');
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败，请稍后重试');
        });
    }
}

// 完成采购
function completePurchase(batchId) {
    if (confirm('确定要完成此采购批次吗？')) {
        fetch('/purchases/complete/' + batchId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('操作成功！');
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败，请稍后重试');
        });
    }
}

// 取消采购
function cancelPurchase(batchId) {
    if (confirm('确定要取消此采购批次吗？此操作不可撤销！')) {
        fetch('/purchases/cancel/' + batchId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('操作成功！');
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('操作失败，请稍后重试');
        });
    }
}

// 显示支付模态框
function showPaymentModal() {
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

// 处理支付
function processPayment() {
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const notes = document.getElementById('paymentNotes').value;
    const accountCode = document.getElementById('paymentAccountCode').value;
    
    if (isNaN(amount) || amount <= 0) {
        alert('请输入有效的支付金额');
        return;
    }
    
    fetch('/purchases/payment/<%= batch.id %>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            amount: amount,
            notes: notes,
            finance_account_code: accountCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('支付成功！');
            location.reload();
        } else {
            alert('支付失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败，请稍后重试');
    });
}
</script>