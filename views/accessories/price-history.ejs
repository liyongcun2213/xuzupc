<%- include('../layout') %>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>配件价格管理</h5>
        <div>
            <button class="btn btn-outline-success me-2" id="exportPriceHistoryBtn">
                <i class="bi bi-file-earmark-spreadsheet"></i> 导出历史价格
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#updatePricesModal">
                <i class="bi bi-arrow-repeat"></i> 批量更新本月价格
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- 月份选择 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="monthSelect" class="form-label">选择月份</label>
                <input type="month" class="form-control" id="monthSelect" value="<%= currentMonth %>">
            </div>
            <div class="col-md-4">
                <label for="categoryFilter" class="form-label">筛选类别</label>
                <select class="form-select" id="categoryFilter">
                    <option value="">所有类别</option>
                    <% categories.forEach(category => { %>
                    <option value="<%= category.id %>"><%= category.name %></option>
                    <% }) %>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="loadPricesBtn" class="btn btn-primary">
                    <i class="bi bi-search"></i> 查询价格
                </button>
            </div>
        </div>

        <!-- 价格表格 -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>配件名称</th>
                        <th>类别</th>
                        <th>品牌</th>
                        <th>型号</th>
                        <th>上月价格</th>
                        <th>本月价格</th>
                        <th>变化率</th>
                        <th>更新状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (priceHistory.length > 0) { %>
                        <% priceHistory.forEach(item => { %>
                        <tr>
                            <td><%= item.name %></td>
                            <td><%= item.category_name %></td>
                            <td><%= item.brand || '-' %></td>
                            <td><%= item.model || '-' %></td>
                            <td>¥<%= (Number(item.last_month_price) || 0).toFixed(2) %></td>
                            <td>
                                <input type="number" class="form-control price-input" 
                                       data-accessory-id="<%= item.id %>" 
                                       value="<%= (Number(item.current_month_price) || 0).toFixed(2) %>" 
                                       step="0.01" min="0">
                            </td>
                            <td>
                                <% if (item.last_month_price && item.current_month_price) { %>
                                    <span class="<%= item.change_rate > 0 ? 'text-danger' : (item.change_rate < 0 ? 'text-success' : '') %>">
                                        <%= item.change_rate > 0 ? '+' : '' %><%= (Number(item.change_rate) || 0).toFixed(2) %>%
                                    </span>
                                <% } else { %>
                                    -
                                <% } %>
                            </td>
                            <td>
                                <% if (item.updated_this_month) { %>
                                    <span class="badge bg-success">已更新</span>
                                <% } else { %>
                                    <span class="badge bg-warning">待更新</span>
                                <% } %>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary save-price-btn" 
                                        data-accessory-id="<%= item.id %>">
                                    <i class="bi bi-check"></i> 保存
                                </button>
                                <button class="btn btn-sm btn-info batch-price-btn" 
                                        data-accessory-id="<%= item.id %>"
                                        data-accessory-name="<%= item.name %>">
                                    <i class="bi bi-table"></i> 批量改价
                                </button>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="9" class="text-center text-muted">
                                <i class="bi bi-info-circle"></i> 没有找到配件价格记录
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 批量更新价格模态框 -->
<div class="modal fade" id="updatePricesModal" tabindex="-1" aria-labelledby="updatePricesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updatePricesModalLabel">批量更新本月价格</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bulkUpdateMonth" class="form-label">月份</label>
                    <input type="month" class="form-control" id="bulkUpdateMonth" value="<%= currentMonth %>">
                </div>
                <div class="mb-3">
                    <label for="priceUpdateType" class="form-label">更新方式</label>
                    <select class="form-select" id="priceUpdateType">
                        <option value="manual">手动输入</option>
                        <option value="percentage">按百分比调整</option>
                    </select>
                </div>
                <div id="manualUpdateSection">
                    <p>点击下方的表格单元格直接编辑价格，或者使用Excel风格的批量操作：</p>
                </div>
                <div id="percentageUpdateSection" style="display:none;">
                    <div class="mb-3">
                        <label for="priceAdjustment" class="form-label">价格调整（百分比）</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="priceAdjustment" 
                                   step="0.1" placeholder="输入-5表示降价5%">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="applyBulkUpdate">应用更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量改价历史表格模态框 -->
<div class="modal fade" id="batchPriceModal" tabindex="-1" aria-labelledby="batchPriceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchPriceModalLabel">批量改价 - <span id="modalAccessoryName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-bordered table-sm" id="batchPriceTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width: 80px;">月份\年份</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1月</td>
                            </tr>
                            <tr>
                                <td>2月</td>
                            </tr>
                            <tr>
                                <td>3月</td>
                            </tr>
                            <tr>
                                <td>4月</td>
                            </tr>
                            <tr>
                                <td>5月</td>
                            </tr>
                            <tr>
                                <td>6月</td>
                            </tr>
                            <tr>
                                <td>7月</td>
                            </tr>
                            <tr>
                                <td>8月</td>
                            </tr>
                            <tr>
                                <td>9月</td>
                            </tr>
                            <tr>
                                <td>10月</td>
                            </tr>
                            <tr>
                                <td>11月</td>
                            </tr>
                            <tr>
                                <td>12月</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> 直接在单元格中输入价格，系统会自动保存。空白表示该月份未设置价格。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-success" id="saveBatchPrices">
                    <i class="bi bi-check-circle"></i> 保存所有修改
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentAccessoryId = null;
    let batchPriceData = {};

    const exportBtn = document.getElementById('exportPriceHistoryBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            window.location.href = '/accessories/price-history/export';
        });
    }
    
    // 加载价格数据
    document.getElementById('loadPricesBtn').addEventListener('click', function() {
        const month = document.getElementById('monthSelect').value;
        const category = document.getElementById('categoryFilter').value;
        
        const params = new URLSearchParams();
        params.append('month', month);
        if (category) params.append('category', category);
        
        window.location.href = `/accessories/price-history?${params.toString()}`;
    });
    
    // 保存单个配件价格
    document.querySelectorAll('.save-price-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const accessoryId = this.getAttribute('data-accessory-id');
            const priceInput = document.querySelector(`.price-input[data-accessory-id="${accessoryId}"]`);
            const newPrice = parseFloat(priceInput.value) || 0;
            
            if (newPrice <= 0) {
                alert('价格必须大于0');
                return;
            }
            
            fetch('/accessories/update-price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    accessory_id: accessoryId,
                    price: newPrice,
                    month: document.getElementById('monthSelect').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.innerHTML = '<i class="bi bi-check-circle"></i> 已保存';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                    
                    // 更新状态徽章
                    const row = this.closest('tr');
                    const statusBadge = row.querySelector('.badge');
                    statusBadge.classList.remove('bg-warning');
                    statusBadge.classList.add('bg-success');
                    statusBadge.textContent = '已更新';
                } else {
                    alert('保存失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        });
    });
    
    // 批量改价按钮事件
    document.querySelectorAll('.batch-price-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentAccessoryId = this.getAttribute('data-accessory-id');
            const accessoryName = this.getAttribute('data-accessory-name');
            
            console.log('点击批量改价，配件ID:', currentAccessoryId, '名称:', accessoryName);
            
            document.getElementById('modalAccessoryName').textContent = accessoryName;
            
            // 先显示模态框
            const modal = new bootstrap.Modal(document.getElementById('batchPriceModal'));
            modal.show();
            
            // 然后加载该配件的历史价格数据
            loadBatchPriceData(currentAccessoryId);
        });
    });
    
    // 加载批量价格数据
    function loadBatchPriceData(accessoryId) {
        console.log('开始加载价格数据，accessoryId:', accessoryId);
        
        fetch(`/accessories/batch-price-history?accessory_id=${accessoryId}`)
            .then(response => {
                console.log('响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('返回数据:', data);
                
                if (data.success) {
                    batchPriceData = data.data;
                    renderBatchPriceTable();
                } else {
                    alert('加载价格数据失败: ' + (data.message || '未知错误'));
                    console.error('加载失败:', data);
                }
            })
            .catch(error => {
                console.error('请求错误:', error);
                alert('加载价格数据失败: ' + error.message);
            });
    }
    
    // 渲染批量价格表格
    function renderBatchPriceTable() {
        const currentYear = new Date().getFullYear();
        const startYear = 2018;
        const years = [];
        
        // 生成年份列表 (2018 到当前年份)
        for (let year = startYear; year <= currentYear; year++) {
            years.push(year);
        }
        
        // 构建表头
        const table = document.getElementById('batchPriceTable');
        const thead = table.querySelector('thead tr');
        thead.innerHTML = '<th style="min-width: 80px;">月份\\年份</th>';
        years.forEach(year => {
            thead.innerHTML += `<th style="min-width: 120px;">${year}</th>`;
        });
        
        // 构建表体
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        
        for (let month = 1; month <= 12; month++) {
            let row = `<tr><td class="fw-bold">${month}月</td>`;
            
            years.forEach(year => {
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                const price = batchPriceData[monthKey] || '';
                
                row += `<td>
                    <input type="number" 
                           class="form-control form-control-sm batch-price-input" 
                           data-month="${monthKey}" 
                           value="${price}" 
                           step="0.01" 
                           min="0"
                           placeholder="当月价格">
                </td>`;
            });
            
            row += '</tr>';
            tbody.innerHTML += row;
        }
        
        // 添加输入框变化监听
        document.querySelectorAll('.batch-price-input').forEach(input => {
            input.addEventListener('change', function() {
                const month = this.getAttribute('data-month');
                const value = parseFloat(this.value);
                
                if (value > 0) {
                    batchPriceData[month] = value;
                } else if (this.value === '') {
                    delete batchPriceData[month];
                }
            });
        });
    }
    
    // 保存批量价格
    document.getElementById('saveBatchPrices').addEventListener('click', function() {
        if (!currentAccessoryId) {
            alert('未选择配件');
            return;
        }
        
        // 收集所有价格数据
        const priceUpdates = [];
        document.querySelectorAll('.batch-price-input').forEach(input => {
            const month = input.getAttribute('data-month');
            const price = parseFloat(input.value);
            
            if (price > 0) {
                priceUpdates.push({
                    month: month,
                    price: price
                });
            }
        });
        
        if (priceUpdates.length === 0) {
            alert('请至少输入一个价格');
            return;
        }
        
        // 显示加载状态
        const saveBtn = this;
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
        saveBtn.disabled = true;
        
        // 发送批量保存请求
        fetch('/accessories/batch-update-prices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                accessory_id: currentAccessoryId,
                prices: priceUpdates
            })
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            
            if (data.success) {
                alert(`成功保存 ${data.updated_count} 条价格记录`);
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('batchPriceModal')).hide();
                // 刷新页面
                window.location.reload();
            } else {
                alert('保存失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            alert('保存失败，请重试');
        });
    });
    
    // 价格更新类型切换
    document.getElementById('priceUpdateType').addEventListener('change', function() {
        const updateType = this.value;
        const manualSection = document.getElementById('manualUpdateSection');
        const percentageSection = document.getElementById('percentageUpdateSection');
        
        if (updateType === 'manual') {
            manualSection.style.display = 'block';
            percentageSection.style.display = 'none';
        } else {
            manualSection.style.display = 'none';
            percentageSection.style.display = 'block';
        }
    });
    
    // 应用批量更新
    document.getElementById('applyBulkUpdate').addEventListener('click', function() {
        const updateType = document.getElementById('priceUpdateType').value;
        const month = document.getElementById('bulkUpdateMonth').value;
        
        if (updateType === 'percentage') {
            const adjustment = parseFloat(document.getElementById('priceAdjustment').value);
            
            if (isNaN(adjustment)) {
                alert('请输入有效的调整百分比');
                return;
            }
            
            // 应用百分比调整到所有价格输入框
            document.querySelectorAll('.price-input').forEach(input => {
                const currentPrice = parseFloat(input.value) || 0;
                const adjustedPrice = currentPrice * (1 + adjustment / 100);
                input.value = adjustedPrice.toFixed(2);
            });
        }
        
        // 关闭模态框
        bootstrap.Modal.getInstance(document.getElementById('updatePricesModal')).hide();
        
        // 保存所有价格
        const promises = [];
        document.querySelectorAll('.price-input').forEach(input => {
            const accessoryId = input.getAttribute('data-accessory-id');
            const price = parseFloat(input.value) || 0;
            
            promises.push(
                fetch('/accessories/update-price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accessory_id: accessoryId,
                        price: price,
                        month: month
                    })
                })
            );
        });
        
        Promise.all(promises)
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(results => {
                const successCount = results.filter(r => r.success).length;
                
                if (successCount === results.length) {
                    alert('所有价格更新成功！');
                    window.location.reload();
                } else {
                    alert(`更新完成：${successCount}个成功，${results.length - successCount}个失败`);
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('批量更新失败，请重试');
            });
    });
    
    // 月份变化时自动加载
    document.getElementById('monthSelect').addEventListener('change', function() {
        document.getElementById('loadPricesBtn').click();
    });
    
    // 类别变化时自动加载
    document.getElementById('categoryFilter').addEventListener('change', function() {
        document.getElementById('loadPricesBtn').click();
    });
});
</script>

<style>
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f8f9fa;
}

#batchPriceTable input.form-control-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

#batchPriceTable th, 
#batchPriceTable td {
    vertical-align: middle;
    text-align: center;
}

#batchPriceTable tbody td:first-child {
    background-color: #f8f9fa;
    font-weight: 500;
}
</style>

<%- include('../base-footer') %>