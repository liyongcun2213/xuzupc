<%- include('../layout') %>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">财务管理</h4>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addFinanceRecordModal">
            <i class="bi bi-plus-circle"></i> 新增收支记录
        </button>
    </div>
</div>

<!-- 财务总览看板 -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card border-left-primary shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">公账总余额</span>
                    <i class="bi bi-bank text-primary"></i>
                </div>
                <h5 class="mb-0">¥<%= (Number(publicBalance) || 0).toFixed(2) %></h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-left-info shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">私账总余额</span>
                    <i class="bi bi-person-lines-fill text-info"></i>
                </div>
                <h5 class="mb-0">¥<%= (Number(privateBalance) || 0).toFixed(2) %></h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-left-success shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">当日现金流</span>
                    <i class="bi bi-cash-coin text-success"></i>
                </div>
                <h5 class="mb-0">¥<%= (Number(todayCashFlow) || 0).toFixed(2) %></h5>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-left-warning shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">当月现金流</span>
                    <i class="bi bi-calendar3 text-warning"></i>
                </div>
                <h5 class="mb-0">¥<%= (Number(monthCashFlow) || 0).toFixed(2) %></h5>
            </div>
        </div>
    </div>
</div>

<!-- 采购待审批/待支付概览 -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">待审批采购</span>
                    <i class="bi bi-hourglass-split text-secondary"></i>
                </div>
                <h6 class="mb-0"><%= pendingStats.pending_approval_count || 0 %> 笔</h6>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm h-100" id="pendingPurchasesCard" style="cursor: pointer;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">待支付采购</span>
                    <i class="bi bi-credit-card text-danger"></i>
                </div>
                <h6 class="mb-1">
                    <span id="pendingPurchasesCount"><%= pendingStats.pending_payment_count || 0 %></span> 笔
                </h6>
                <div class="small text-muted">
                    待支付金额：¥<span id="pendingPurchasesAmount"><%= (Number(pendingStats.pending_payment_amount) || 0).toFixed(2) %></span>
                </div>
                <div class="small text-primary mt-1">点击查看未支付的采购订单</div>
            </div>
        </div>
    </div>
</div>

<!-- 流水账过滤与列表 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <span>财务流水账</span>
        </div>
        <form class="d-flex align-items-center" method="get" action="/finance">
            <label class="me-2 small text-muted">账户：</label>
            <select class="form-select form-select-sm me-2" name="account" onchange="this.form.submit()">
                <option value="" <%= !accountFilter ? 'selected' : '' %>>全部</option>
                <option value="public" <%= accountFilter === 'public' ? 'selected' : '' %>>公账</option>
                <option value="private" <%= accountFilter === 'private' ? 'selected' : '' %>>私账</option>
            </select>
        </form>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>账户</th>
                        <th>记录类型</th>
                        <th>类别</th>
                        <th>金额</th>
                        <th>描述</th>
                        <th>关联ID</th>
                        <th>关联类型</th>
                        <th>交易日期</th>
                        <th>创建人</th>
                        <th>创建时间</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (records && records.length > 0) { %>
                        <% records.forEach(record => { %>
                        <tr>
                            <td><%= record.id %></td>
                            <td><%= record.account_name || '-' %></td>
                            <td>
                                <span class="badge bg-<%= record.record_type === 'income' ? 'success' : 'danger' %>">
                                    <%= record.record_type === 'income' ? '收入' : '支出' %>
                                </span>
                            </td>
                            <td><%= record.category %></td>
                            <td>
                                <span class="<%= record.record_type === 'income' ? 'text-success' : 'text-danger' %>">
                                    <%= record.record_type === 'income' ? '+' : '-' %>¥<%= parseFloat(record.amount).toFixed(2) %>
                                </span>
                            </td>
                            <td><%= record.description || '-' %></td>
                            <td><%= record.reference_id || '-' %></td>
                            <td><%= record.reference_type || '-' %></td>
                            <td><%= moment(record.transaction_date).format('YYYY-MM-DD') %></td>
                            <td><%= record.created_by_name || '-' %></td>
                            <td><%= moment(record.created_at).format('YYYY-MM-DD HH:mm') %></td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="11" class="text-center py-4 text-muted">暂无财务记录</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 新增财务记录模态框（用于固定支出等） -->
<!-- 未支付采购订单列表模态框 -->
<div class="modal fade" id="pendingPurchasesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">未支付的采购订单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>批次号</th>
                                <th>供应商</th>
                                <th>采购日期</th>
                                <th>预计到货</th>
                                <th class="text-end">总金额</th>
                                <th class="text-end">已支付</th>
                                <th class="text-end">未支付</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pendingPurchasesTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-3 text-muted">正在加载数据...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 财务端支付采购款模态框 -->
<div class="modal fade" id="financePaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">支付采购款</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="financePaymentBatchId">
                <div class="mb-3">
                    <label for="financePaymentAmount" class="form-label">支付金额</label>
                    <div class="input-group">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" id="financePaymentAmount" step="0.01" min="0">
                    </div>
                    <div class="form-text">最大可支付金额: ¥<span id="financeMaxPaymentAmount">0.00</span></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="financePaymentAccountCode" class="form-label">支付账户（公账/私账） <span class="text-danger">*</span></label>
                        <select class="form-select" id="financePaymentAccountCode">
                            <option value="public" selected>公司公账</option>
                            <option value="private">法人私账</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="financePaymentNotes" class="form-label">支付说明</label>
                        <textarea class="form-control" id="financePaymentNotes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="processFinancePurchasePayment()">确认支付</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addFinanceRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增财务记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="financeRecordForm">
                    <div class="mb-3">
                        <label class="form-label">记录类型 <span class="text-danger">*</span></label>
                        <select class="form-select" name="record_type" required>
                            <option value="income">收入</option>
                            <option value="expense" selected>支出</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">类别 <span class="text-danger">*</span></label>
                        <select class="form-select" name="category" required>
                            <option value="电脑租金收入">电脑租金收入</option>
                            <option value="配件销售收入">配件销售收入</option>
                            <option value="电脑销售收入">电脑销售收入</option>
                            <option value="工资">工资</option>
                            <option value="租金">房租</option>
                            <option value="水电费">水电费</option>
                            <option value="社保">社保</option>
                            <option value="办公费">办公费</option>
                            <option value="维修费">维修费</option>
                            <option value="保险费">保险费</option>
                            <option value="税费">税费</option>
                            <option value="其他固定成本">其他固定成本</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">金额 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">交易日期 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="transaction_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">记入账户 <span class="text-danger">*</span></label>
                        <select class="form-select" name="account_code" required>
                            <option value="public" selected>公账</option>
                            <option value="private">私账</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="可填写工资月份、水电周期等"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitFinanceRecord()">保存</button>
            </div>
        </div>
    </div>
</div>


</main>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 初始化新增记录表单默认日期
(function() {
    const form = document.getElementById('financeRecordForm');
    if (form) {
        const dateInput = form.querySelector('input[name="transaction_date"]');
        if (dateInput && !dateInput.value) {
            const today = new Date();
            dateInput.valueAsDate = today;
        }
    }
})();

function submitFinanceRecord() {
    const form = document.getElementById('financeRecordForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    if (!data.amount || parseFloat(data.amount) <= 0) {
        alert('请输入有效的金额');
        return;
    }

    fetch('/api/finance/records', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert('保存成功');
            bootstrap.Modal.getInstance(document.getElementById('addFinanceRecordModal')).hide();
            form.reset();
            window.location.reload();
        } else {
            alert('保存失败：' + (result.message || '未知错误'));
        }
    })
    .catch(err => {
        console.error('保存财务记录失败:', err);
        alert('保存失败，请稍后重试');
    });
}

// 财务待支付采购卡片点击事件
(function() {
    const card = document.getElementById('pendingPurchasesCard');
    const countSpan = document.getElementById('pendingPurchasesCount');

    if (!card || !countSpan) {
        return;
    }

    card.addEventListener('click', function() {
        const count = parseInt(countSpan.textContent || '0', 10);
        if (!count) {
            alert('当前没有未支付的采购订单');
            return;
        }

        const tbody = document.getElementById('pendingPurchasesTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-muted">正在加载数据...</td></tr>';
        }

        fetch('/api/finance/pending-purchases')
            .then(res => res.json())
            .then(result => {
                if (!result.success) {
                    alert('加载未支付采购订单失败：' + (result.message || '未知错误'));
                    return;
                }

                const rows = result.data || [];
                if (!tbody) {
                    return;
                }

                if (!rows.length) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-muted">当前没有未支付的采购订单</td></tr>';
                    return;
                }

                tbody.innerHTML = rows.map(row => {
                    const total = parseFloat(row.total_amount || 0) || 0;
                    const paid = parseFloat(row.paid_amount || 0) || 0;
                    const unpaid = parseFloat(row.unpaid_amount || (total - paid)) || 0;

                    let statusText = row.status || '';
                    if (statusText === 'pending') statusText = '待审批';
                    else if (statusText === 'approved') statusText = '已审批';
                    else if (statusText === 'delivered') statusText = '已到货';
                    else if (statusText === 'completed') statusText = '已完成';
                    else if (statusText === 'cancelled') statusText = '已取消';

                    const purchaseDate = row.purchase_date ? new Date(row.purchase_date).toISOString().split('T')[0] : '';
                    const expectedDate = row.expected_delivery_date ? new Date(row.expected_delivery_date).toISOString().split('T')[0] : '';

                    return `
                        <tr>
                            <td>${row.batch_no}</td>
                            <td>${row.supplier_name || '-'}</td>
                            <td>${purchaseDate}</td>
                            <td>${expectedDate || '未设定'}</td>
                            <td class="text-end">¥${total.toFixed(2)}</td>
                            <td class="text-end">¥${paid.toFixed(2)}</td>
                            <td class="text-end text-danger">¥${unpaid.toFixed(2)}</td>
                            <td>${statusText}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openFinancePaymentModal(${row.id}, ${unpaid.toFixed(2)}, '${row.status}')">
                                    支付
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error('加载未支付采购订单失败:', err);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center py-3 text-danger">加载失败，请稍后重试</td></tr>';
                }
            });

        const modalEl = document.getElementById('pendingPurchasesModal');
        if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    });
})();

function openFinancePaymentModal(batchId, maxAmount, status) {
    const batchIdInput = document.getElementById('financePaymentBatchId');
    const amountInput = document.getElementById('financePaymentAmount');
    const maxAmountSpan = document.getElementById('financeMaxPaymentAmount');

    if (!batchIdInput || !amountInput || !maxAmountSpan) {
        return;
    }

    batchIdInput.value = String(batchId);
    const normalizedMax = Number(maxAmount) || 0;
    amountInput.value = normalizedMax.toFixed(2);
    amountInput.max = normalizedMax;
    maxAmountSpan.textContent = normalizedMax.toFixed(2);

    const modalEl = document.getElementById('financePaymentModal');
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

function processFinancePurchasePayment() {
    const batchIdInput = document.getElementById('financePaymentBatchId');
    const amountInput = document.getElementById('financePaymentAmount');
    const notesInput = document.getElementById('financePaymentNotes');
    const accountSelect = document.getElementById('financePaymentAccountCode');

    const batchId = batchIdInput ? batchIdInput.value : '';
    const amount = amountInput ? parseFloat(amountInput.value) : 0;
    const notes = notesInput ? notesInput.value : '';
    const accountCode = accountSelect ? accountSelect.value : 'public';

    if (!batchId) {
        alert('未找到要支付的采购批次');
        return;
    }

    if (!amount || amount <= 0) {
        alert('请输入有效的支付金额');
        return;
    }

    fetch(`/purchases/payment/${batchId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            amount: amount,
            notes: notes,
            finance_account_code: accountCode
        })
    })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('支付失败：' + (data.message || '未知错误'));
                return;
            }

            const isFullyPaid = typeof data.totalAmount === 'number' && typeof data.newPaidAmount === 'number'
                ? data.newPaidAmount >= data.totalAmount - 0.01
                : false;

            const shouldAutoComplete = isFullyPaid && data.batchStatus === 'delivered';

            const doAfterComplete = () => {
                alert('支付成功！');

                const paymentModalEl = document.getElementById('financePaymentModal');

            if (paymentModalEl) {
                const paymentModal = bootstrap.Modal.getInstance(paymentModalEl);
                if (paymentModal) {
                    paymentModal.hide();
                }
            }

            const pendingModalEl = document.getElementById('pendingPurchasesModal');
            if (pendingModalEl) {
                const pendingModal = bootstrap.Modal.getInstance(pendingModalEl);
                if (pendingModal) {
                    pendingModal.hide();
                }
            }

            window.location.reload();
        };

        if (shouldAutoComplete) {
            fetch(`/purchases/complete/${batchId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(res => res.json())
                .then(completeResult => {
                    if (!completeResult.success) {
                        console.error('自动完成采购失败:', completeResult.message);
                    }
                    doAfterComplete();
                })
                .catch(err => {
                    console.error('自动完成采购请求失败:', err);
                    doAfterComplete();
                });
        } else {
            doAfterComplete();
        }
        })
        .catch(error => {
            console.error('支付请求失败:', error);
            alert('支付失败，请稍后重试');
        });
}
</script>
</body>
</html>