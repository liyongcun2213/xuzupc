==================== 客户消费管理系统说明 ====================

一、系统概述
-----------
本系统基于预付费模式，客户在租赁前预付3个月租金，系统每天自动扣除租金。
当余额为负数时，系统自动标记客户为欠费状态。

二、数据库表结构
--------------
1. customer_accounts - 客户账户表
   - 存储客户的预付金额、已消耗金额、余额和状态
   
2. payment_records - 缴费记录表
   - 记录所有客户的缴费历史
   
3. daily_charge_records - 每日扣费记录表
   - 记录每天对每台设备的扣费详情
   
4. customer_transaction_details - 客户消费明细表
   - 记录所有交易明细（缴费、扣费、退款、调整）

三、客户状态
-----------
- paid (已缴费): 余额 >= 0
- overdue (已欠费): 余额 < 0
- terminated (已退租): 手动设置

四、功能说明
-----------
1. 客户消费管理页面
   - 访问地址: http://localhost:3000/customer-billing
   - 功能: 查看所有客户的消费情况、缴费、查看详情

2. 自动扣费任务
   - 执行时间: 每天凌晨 2:00
   - 扣费规则: 根据租赁周期计算日租金
     * 日租: 日租金 = 租金
     * 月租: 日租金 = 租金 / 30
     * 季租: 日租金 = 租金 / 90
     * 年租: 日租金 = 租金 / 365

3. 欠费判断
   - 自动判断: 每次扣费后自动检查余额，余额<0则标记为欠费
   - 缴费恢复: 客户缴费后，余额>=0自动恢复为已缴费状态

五、API接口
----------
1. GET /api/customer-billing/list
   - 功能: 获取客户消费列表
   - 参数: status (all/paid/overdue/terminated), keyword

2. GET /api/customer-billing/detail/:customerId
   - 功能: 获取客户详情

3. POST /api/customer-billing/payment
   - 功能: 客户缴费
   - 参数: customerId, amount, paymentMethod, operator, notes

4. POST /api/customer-billing/trigger-daily-charge
   - 功能: 手动触发每日扣费（测试用）

六、测试数据
-----------
系统已自动创建3个测试客户：
- KH0001 - 小李 (欠费 ¥3707.93)
- KH0002 - 恒炬科技 (欠费 ¥3433.92)
- KH0003 - 远洋集团 (已缴费 ¥0.00)

七、手动执行扣费
--------------
如需手动执行扣费任务（测试用）：
1. 命令行执行: node daily-charge-task.js
2. 或访问API: POST http://localhost:3000/api/customer-billing/trigger-daily-charge

八、注意事项
-----------
1. 系统会自动跳过当天已扣费的记录，避免重复扣费
2. 扣费失败不会影响其他客户的扣费
3. 所有扣费操作都使用数据库事务，保证数据一致性
4. 定时任务在服务器启动时自动启动

九、后续开发建议
--------------
1. 添加欠费通知功能（短信/邮件）
2. 添加自动停机功能（欠费超过N天）
3. 添加缴费提醒功能（余额低于阈值）
4. 添加退租退款功能
5. 添加账户调整功能（人工调整余额）
6. 添加报表统计功能

============================================================
